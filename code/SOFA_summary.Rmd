---
params:
 rep_title: "Sea otter foraging analysis (SOFA) V. 2.*" 
 rep_date: "10/20/2020" 
 show.grptxt: TRUE
 GL1: 1
 GL2: 2
 GL3: 0
title: "`r params$rep_title`"
date: "`r params$rep_date`"
author: "SOFA created for U.S. Geological Survey and Seattle Aquarium by M.T. Tinker, Nhydra Ecological"
output:
  html_document: 
    fig_width: 9
editor_options:
  chunk_output_type: console
---

<img src="SOFA_logo.png" alt="logo" style="height: 140px; width:750px; margin:0px 50px"/>
<div style="margin-bottom:50px;">

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

existing_Packages<-as.list(installed.packages()[,1])
# Add new packages you might need to this line, to check if they're installed and install missing packages
required_Packages<-c("rstan","ggplot2", "gridExtra", "bayesplot", "dplyr", "gtools","knitr")
missing_Packages<- required_Packages[!required_Packages%in% existing_Packages]
if(length(missing_Packages)>0)install.packages(pkgs =  missing_Packages, repos = "http://cran.us.r-project.org")
invisible(lapply(required_Packages, require, character.only=T,quietly = T))
rm(existing_Packages, missing_Packages, required_Packages)
#
# Load results file
load(file="Results.rdata")
# Set T/F key for Group option, use to determine whether to evaluate certain chunks
#  using ```{r, eval=Grp_TF} 
Grp_TF = GrpOpt==1
r_mcmc = sample(Nsims,min(2500,Nsims),replace = F)
post = mcmc[r_mcmc,]

```

## Summary

This report summarizes the results of an analysis of sea otter observation-based foraging data. The analytic approach is referred to as the "Sea Otter Foraging Analysis", or SOFA. Standard variables recorded in the field from foraging sea otters - duration of dive and surface intervals, prey captures, prey sizes, etc. - are first summarized for all the dives in each feeding bout, and then Bayesian methods are used to fit a process model to these observed data, in order to estimate key "latent" parameters. Latent parameters of interest include how sea otters allocate their effort to foraging for different prey types, how much each of these prey types contributes to the resulting diet, several prey-specific parameters (mean size, handling time, consumption rates, and the functional relationship between the latter two parameters and prey size), and the overall net rate of biomass consumption and energy intake. The process model uses a probabilistic approach to account for incomplete data (including un-identified prey and missing data fields from some records), and the inherent biases associated with incomplete data (e.g. which types and sizes of prey are more likely to be recorded as un-identified). The resulting parameter estimates account for all sources of uncertainty, including sampling error, measurement error, uncertainty in the functional relationship between prey size and edible biomass, error in caloric density estimates, and various other sources of parameter uncertainty.  

The results of the model fitting are presented below for the entire data set, and (if specified during model set-up) for each unique "level" of one or more categorical grouping variables. Grouping variables can include area, time period, otter ID, or reproductive status.  

<div style="margin-bottom:50px;">
</div>

## Methods
### Observation model
SOFA is based around a simple conceptual model of sea otter foraging that corresponds to what an observer records in the field. Specifically, during a period of feeding activity (a “Bout”, consisting of a contiguous sequence of dives) foraging sea otters make decisions as to how to allocate their effort among multiple potential prey types. The term “prey type” is used in a flexible way: a prey type may be a single species (*Tegula brunnea*), or it may be a group of related species (e.g. “marine snails”). Each prey type can be defined by its frequency of encounter (or the inverse of encounter rate, which is the time required to find and capture one or more items of the prey while diving), the time required to handle an item of that prey type once captured, the size of each item and the number of items captured per dive.  The total time in a bout allocated to each prey type *j* consists of the sum of the dive durations (*DT*~j~) allocated to acquiring that prey type, and the sum of time at the surface spent handling items of that prey type (*HT*~j~), both of which are measured in seconds.  For dives where multiple prey types are captured, it is reasonable to divide the relevant *DT* and *HT* among the prey types captured on that dive, proportional to their size and number.  In addition to the confirmed time allocated to each prey type, there is also “unallocated time” (*UT*) during a bout, which consists of the total duration of unsuccessful dives and time at surface (*ST*) not handing prey. We can partition this unallocated time among prey types according to their proportional contributions to confirmed allocated time, *PA*~j~.  Thus, the total number of minutes (*TM*) allocated to prey type *j* in bout *i* is calculated as:
$$T{{M}_{j,i}}~=\frac{1}{60}\left[ \sum{D{{T}_{j,i}}+}\sum{H{{T}_{j,i}}+}\left( P{{A}_{j,i}}\sum{UT_i} \right) \right]$$

We note that one of the prey types for which we calculate total allocated minutes consists of un-identified prey items (UNID): we assume that these UNID prey items are a collection of all the other known prey types, but we do not know *a priori* the proportion of each known prey type comprising the UNID category.

In addition to calculating the total time allocated to each prey in each bout, we can also calculate the biomass consumed for each prey type: this is accomplished by converting the linear size of each prey item (*SZ*~j~, in mm) to biomass. Linear size is estimated by observers as the maximum linear dimension of a prey item relative to a paw width (excluding appendages), and this value is converted into an estimate of edible biomass using a set of empirically derived log-log functional relationships between linear dimension and edible biomass for each prey type. We then sum the estimated edible biomass for all recorded items of prey type *j* observed in a bout (or a portion of a bout), and divide by the total number of minutes of a bout allocated to prey type *j*in that bout (or a portion of a bout), to obtain the observed consumption rate for that prey type (*CRobs*~j,i~), in g/min.  For each observed bout we calculate several key statistics: *TM*~j,i~ and *CRobs*~j,i~, as well as the mean values of handling time and prey size for each prey type (*HTmn*~j,i~ and *SZmn*~j,i~ ).  

### Process model
The observed activity of sea otter foraging can be approximated by a sequence of mathematical equations that together represent the process model, the expected dynamics of which are determined by the values of the parameters in the equations (Table 1). We let $\eta_j$ represent the mean proportional allocation of foraging effort to prey type *j*, excluding the UNID class (i.e. TRUE effort allocation if all prey were positively identified), such that:
$$\sum_{j=1}^{J} \eta_j=1$$
  
For each prey type *j* we also specify parameter $\omega_j$ as the probability that an item of that prey type will be positively identified. We calculate values of $\omega_j$ based on the empirical distributions of the log of handling time and the log of mean prey size of prey type *j*, and the degree to which these distributions overlap with the same distributions for the UNID prey class. We measure joint proportional overlap of multiple distributions using the Bhattacharyya coefficient. Our rationale is that the more similar the density distributions of these attributes are between UNID and prey type *j*, the more likely it is that *j* contributes to the UNID prey class. To account for unidentified prey in our observed data set, we define the parameter $\alpha$ as the relative allocation of effort to each prey type INCLUDING the UNID prey class. For positively identified prey types:
$${{\alpha }_{j}}={{\eta }_{j}}\cdot {{\omega }_{j}}\cdot \tau_B $$
while for the unidentified prey class (UNID):
$${{\alpha }_{u}}=\sum\limits_{j}{{{\eta }_{j}}\cdot \left( 1-{{\omega }_{j}} \right)\cdot \tau_B }$$

The parameter $\tau_B$ represents a fitted precision parameter, which allows us to use $\alpha_j$ as the base parameters for a Dirichlet-Multinomial distribution that defines the relative probabilities of a prey type being observed in a given bout:
$$\left[ {{\theta }_{j,i}} \right] \sim Dirichlet\left( {{\alpha }_{1}},{{\alpha }_{2}},\ ...\ {{\alpha }_{J}},{{\alpha }_{U}} \right)$$
where $\theta_{j,i}$ is the expected proportional allocation of effort to each prey type for bout *i*.

We define parameter $\mu_{s,j}$ as the mean log size (mm) for each prey type. For handling time and consumption rate, we note that both of these parameters are correlated strongly with prey size: specifically, there is an approximately linear relationship between the log of each variable and the log of prey size.  We therefore calculate expected log handling time ($\mu_{h,j}$) and expected log consumption rate ($\mu_{c,j}$) as derived parameters:
$${{\mu }_{h,j}}={{\psi }_{1,j}}+{{\psi }_{2,j}}\cdot \log (SZmn)$$
$${{\mu }_{c,j}}={{\phi }_{1,j}}+{{\phi }_{2,j}}\cdot \log (SZmn)$$
where the fitted parameters $phi_{1,j}$, $phi_{2,j}$, $psi_{1,j}$, and $psi_{2,j}$, together describe the functional relationships between handling time, consumption rate, and prey size for each prey type.  We note that $\mu_{h,j}$ and $\mu_{c,j}$ are calculated for each bout, based on the mean log size of prey type *j* on that bout, but we can also calculate mean values based on the mean log prey size over all bouts. Specifically, if we define ${\bar{\mu}}_{s,j}$ as the mean log size of prey type *j* over the entire data set, then we can calculate mean size, handling time and consumption rate for prey type *j* as:
$${{{\bar{S}}}_{j}}=\exp \left( {{\mu }_{s,j}}+{}^{\sigma _{s,j}^{2}}\!\!\diagup\!\!{}_{2}\; \right)$$
$${{{\bar{H}}}_{j}}=\exp \left( ({{\mu }_{h,j}}|{{\mu }_{s,j}},{{\psi }_{j}})+{}^{\sigma _{h,j}^{2}}\!\!\diagup\!\!{}_{2}\; \right)$$
$${{\overline{cr}}_{j}}=\exp \left( ({{\mu }_{c,j}}|{{\mu }_{s,j}},{{\phi }_{j}})+{}^{\sigma _{c,j}^{2}}\!\!\diagup\!\!{}_{2}\; \right)$$

We define several other "derived" parameters that help simplify or expand our interpretation of model results. The rate of energy intake associated with foraging on prey type *j* (*er*~j~) is calculated by multiplying the consumption rate of prey type *j* by the caloric density of edible biomass (*Cdens*~j~) for that prey type, based on published values.  We also integrate consumption rate and energy intake rates across all prey types, accounting for proportional allocation of effort among prey types, to obtain the overall consumption rate (CR) and energy intake rate (ER):  
$$\overline{CR}=\sum\limits_{j=1}^{J}{{{\eta }_{j}}\cdot {{\overline{cr}}_{j}}}$$
$$\overline{ER}=\sum\limits_{j=1}^{J}{{{\eta }_{j}}\cdot {{\overline{cr}}_{j}}\cdot Cden{{s}_{j}}}$$

Diet composition, defined as the proportional contribution (in terms of consumed biomass) of each prey type to the overall diet ($/pi_j$), is calculated as: 
$${{\pi }_{j}}={\left( {{\eta }_{j}}\cdot {{\overline{cr}}_{j}} \right)}/{\sum\limits_{j=1}^{J}{{{\eta }_{j}}\cdot {{\overline{cr}}_{j}}}}\;$$

Finally, the process model can be modified to account for random effects of categorical group variables (age, sex, area, time period) by utilizing a hierarchical approach for certain key parameters.  We allow foraging effort to vary across groups using a Dirichlet-Multinomial approach:
$${{\eta }_{g,j}}\sim Dirichlet\left( {{\eta }_{j}}\cdot {{\tau }_{G}} \right)$$
where $\eta_{g,j}$ is the mean proportional allocation of foraging effort to prey type *j* in bouts belonging to group level *g*, and parameter $\tau_G$ is a fitted precision parameter that determines the degree of consistency in diet across groups. We assume that log prey size for each prey type is normally distributed across groups with mean equal to ${\bar{\mu}}_{s,j}$ and standard error as a fitted parameter.  We make the same assumption for $phi_{1,j}$ and $psi_{1,j}$, thereby allowing prey specific handling times and consumption rates to vary across groups.  By treating these base parameters hierarchically, we also allow for variation in the derived parameters of diet composition, mean consumption rates and mean energy intake rates across groups. Table 1 provides a summary of all parameters estimated by the model.

##### **Table 1. Summary of estimated parameters**
|Parameter | Description |
|:--------|---------|
| $\overline{CR}$ | Mean overall net consumption rate (CR, g/min) while foraging |
| $\overline{ER}$ | Mean overall net energy intake rate (ER, kcal/min) while foraging |
| ${{\bar{S}}_{j}}$ | Mean size, prey type j |
| ${{\bar{H}}_{j}}$ | Mean handling time, prey type j |
| ${{\bar{cr}}_{j}}$ | Mean consumption rate, prey type j |
| ${{\bar{er}}_{j}}$ | Mean energy intake rate, prey type j |
| ${{\bar{\phi }}_{1,j}}$ | CR vs log(Size) function, intercept parameter, prey type j  |
| ${{\phi }_{2,j}}$ | CR vs log(Size) function, slope parameter, prey type j |
| ${{\bar{\psi }}_{1,j}}$ | HT vs log(Size) function, intercept parameter, prey type j  |
| ${{\psi }_{2,j}}$ | HT vs log(Size) function, slope parameter, prey type j |
| ${{\bar{\eta }}_{j}}$ | Proportion of foraging effort allocated to prey type j |
| ${{\bar{\pi }}_{j}}$ | Proportion of diet (biomass consumed) made up of prey type j |
| ${{\bar{\omega }}_{j}}$ | Proportion of prey type j identified (not recorded as "un-identified" prey) |
| $\sigma_{c,j}$ | Std error in log(CR) across bouts for a given prey type |
| $\sigma_{h,j}$ | Std error in log(H) across bouts for a given prey type |
| $\sigma_{s,j}$ | Std error in log(S) across bouts for a given prey type |
| ${{\tau }_{B}}$ | Precision (consistency) in diet composition across bouts (within group) |
| ${{\tau }_{G}}$ | Precision (consistency) in diet composition across groups (if defined)|
| ${{CR}_{g}}$ | Mean net consumption rate (CR, g/min) while foraging, group g |
| ${{ER}_{g}}$ | Mean net energy intake rate (ER, kcal/min) while foraging, group g |
| ${{S}_{g,j}}$ | Mean size, prey type j, group g |
| ${{H}_{g,j}}$ | Mean handling time, prey type j, group g |
| ${{cr}_{g,j}}$ | Mean consumption rate, prey type j, group g |
| ${{er}_{g,j}}$ | Mean energy intake rate, prey type j, group g |
| ${{\phi }_{1,g,j}}$ | CR vs log(Size) function, intercept parameter, prey type j, group g |
| ${{\psi }_{1,g,j}}$ | HT vs log(Size) function, intercept parameter, prey type j, group g |
| ${{\eta }_{g,j}}$ | Proportion of foraging effort allocated to prey type j, group g |
| ${{\pi }_{g,j}}$ | Proportion of diet (biomass consumed) made up of prey type j, group g |
| ${{\omega }_{g,j}}$ | Proportion of prey type j identified, group g |
*Note: parameters with 'g' subscripts estimated if by-groups were incorporated in analysis*

### Relating observation model and process model
By comparing expected distributions from the process model with observed data, the statistics recorded from foraging bouts constrain the possible values of the parameters of the process model. Specifically, we assume that the observed distribution of minutes allocated to each prey type on a given bout can be described by a multinomial distribution:
$$\left[ T{{M}_{j,i}} \right]\sim Multinomial\left( \left[ {{\theta }_{j,i}} \right] \right)$$

We assume that observed mean prey size for prey type *j* is described by a log-normal distribution:
$$SZm{{n}_{j,i}}\sim\ lognormal\left( {{\mu }_{s,j}},{{\sigma }_{s,j}} \right)$$
where $\sigma_{s,j}$ is a parameter describing the variance in the mean size of prey *j* across bouts.  

We assume that observed mean handling time and mean consumption rate for prey type *j* are also described by log-normal distributions:
$$HTm{{n}_{j,i}}\sim\ lognormal\left( {{\mu }_{h,j}},{{\sigma }_{h,j}} \right)$$
$$CRob{{s}_{j,i}}\sim\ lognormal\left( {{\mu }_{c,j}},{{\sigma }_{c,j}} \right)$$
where $\sigma_{h,j}$ and $\sigma_{c,j}$ are fitted parameters describing variance in these statistics across bouts.  

We used standard Markov-Chain Monte Carlo methods to fit the model to the foraging data, with uninformative priors for all model parameters.  We evaluated model convergence by graphically examining chain mixing and ensuring that the Rhat statistic was close to 1 for all estimated parameters. We evaluated model fit using graphical posterior predictive checks, ensuring that the distributions of out-of-sample predictions were consistent with observed data. We present summaries of posterior distributions for both base parameters and derived parameters such as energy intake rate.

<div style="margin-bottom:50px;">
</div>

## Results
Both graphical and tabular results are presented below. In some cases prey types are referred to numerically (e.g. as subscripts for prey-specific parameters), in which case the numbers correspond to prey types as summarized in Table 2. 

```{r Table2, echo=FALSE}
kable(dfPtp, row.names = FALSE, align = "l",
      caption = "Table 2. Prey types included in the analysis")

```

The posterior estimates for net consumption rate (CR) and energy intake rate (ER), for the data set as a whole, are shown in Figure 1, and summarized in Table 3. Posterior density plots are also shown for estimates of foraging effort allocation among prey types, proportional contribution to diet (in terms of consumed biomass) by prey type, and estimates mean handling time, size, consumption rate and energy intake rate for each prey type. 

If the SOFA analysis being summarized incorporated group-level differences in foraging behavior (e.g. area-based differences, time-based differences or differences among individual animals), a second series of plots are presented showing the same statistics described above but for each level of the grouping variable(s). `r if(params$show.grptxt){" See Table 2b"}`

```{r Table2b, echo=FALSE, eval=Grp_TF}
kable(Grouplist, row.names = FALSE, align = "l",
      caption = "Table 2b. Group levels used for by-group statitics")

```

Tabular summaries of all statistics (both for all data combined and by group levels, if appropriate) are provided at the end of the report.

<div style="margin-bottom:50px;">
</div>

### Figures, statistics for ALL data 

```{r Fig1, echo=FALSE, warning=FALSE, fig.cap = "Figure 1. Density plot showing posterior distributions for consumption rate (${{\\bar{CR}}}$, g/min) and rate of energy intake (${{\\bar{ER}}}$, kcal/min) for the overall data set"}
plot_title = "Overall mean Consumption Rate (CR, g/min) and Energy Intake Rate (ER, kcal/min)"
suppressMessages(print(
mcmc_areas(post,area_method = c("equal height"),
  pars = c("CRmn", "ERmn"),
  prob = 0.8) + ggtitle(plot_title,subtitle = paste0("Forage data ", Projectname))  
  # scale_x_continuous(name="Parameter value",limits=c(0,30))
))

```

```{r Fig2, echo=FALSE, warning=FALSE, fig.cap = "Figure 2. Density plot showing posterior distributions for $\\pi$~*j*~, the proportion of diet (biomass consumed) made up of prey type *j* "}

plot_title = "Proportional contribution to diet (by consumed biomass)"
suppressMessages(print(
mcmc_areas(post,area_method = c("equal height"),
  pars = paste0("PI[",seq(1,(NPtypes-1)),"]"),
  prob = 0.8) + 
  scale_y_discrete(name="Diet Type",labels=dfPtp$Description) +
  ggtitle(plot_title,subtitle = paste0("Forage data ", Projectname)) 
))

```

```{r Fig3, echo=FALSE, warning=FALSE, fig.cap = "Figure 3. Caterpiller plot showing posterior distributions for $\\eta$~*j*~, the relative allocation of effort to each prey type *j* "}

plot_title = "Proportional allocation of foraging effort"
suppressMessages(print(
mcmc_intervals(post,
               pars = paste0("eta[",seq(1,(NPtypes-1)),"]")) +
  scale_y_discrete(name="Diet Type",labels=dfPtp$Description) +
  ggtitle(plot_title,subtitle = paste0("Forage data ", Projectname)) 
))

```

```{r Fig4, echo=FALSE, warning=FALSE, fig.cap = "Figure 4. Caterpiller plot showing posterior distributions for *er*~*j*~, the rate of energy intake while feeding on each prey type *j* "}

plot_title = "Rate of Energy Intake (kcal/min) by prey type"
suppressMessages(print(
mcmc_intervals(post,
               pars = paste0("ER[",seq(1,(NPtypes-1)),"]")) +
  scale_y_discrete(name="Diet Type",labels=dfPtp$Description) +
  ggtitle(plot_title,subtitle = paste0("Forage data ", Projectname)) 
))

```

```{r Fig5, echo=FALSE, warning=FALSE, fig.cap = "Figure 5. Caterpiller plot showing posterior distributions for $\\omega$~*j*~, the probability of positive ID for each prey type *j* "}

plot_title = "Probability of positive ID (i.e. not being recorded as 'Un-ID')"
suppressMessages(print(
mcmc_intervals(post,
               pars = paste0("Omega[",seq(1,(NPtypes-1)),"]")) +
  scale_y_discrete(name="Diet Type",labels=dfPtp$Description) +
  ggtitle(plot_title,subtitle = paste0("Forage data ", Projectname)) 
))

```

<div style="margin-bottom:50px;">
</div>

`r if(params$show.grptxt){"### Figures, statistics by group level "}`

```{r Fig6, echo=FALSE, warning=FALSE, eval=Grp_TF, fig.cap = "Figure 6. Density plot showing posterior distributions for rate of energy intake (*ER*~*g*~, kcal/min) for each group level "}

  if(length(Grpvar)==1){
    Grpvartxt = Grpvar
  }else{
    Grpvartxt = paste(Grpvar, collapse = ', ')
  }

  plot_title = paste0("Posterior distributions, Energy Intake Rate (kcal/min) by ", Grpvartxt)
  suppressMessages(print(
    mcmc_areas(post,
               pars = paste0("ERgmn[",seq(1,Ngrp),"]"),
               prob = 0.8) + ggtitle(plot_title,subtitle = paste0("Forage data ", Projectname))  
    + scale_y_discrete(name="Group",labels=Grouplist$Groupname)
  ))

```

```{r Fig7, echo=FALSE, warning=FALSE, eval=Grp_TF, fig.cap = "Figure 7. Caterpiller plots showing posterior distributions for $\\pi$~*g,j*~, the proportion of diet (biomass consumed) made up of prey type *j* for group *g* "}

  if(length(Grpvar)==1){
    Grpvartxt = Grpvar
  }else{
    Grpvartxt = paste(Grpvar, collapse = ', ')
  }
  
  GL = numeric()
  if(params$GL1>0){GL = c(GL,params$GL1) }
  if(params$GL2>0){GL = c(GL,params$GL2) }
  if(params$GL3>0){GL = c(GL,params$GL3) }

  plot_title = c(paste0("Proportional contribution to diet (by biomass), by ",Grpvartxt,
                      ", Forage data ",Projectname),"","")
  plts = list()
  for(g in 1:length(GL)){
    gl = GL[g]
    plts[[g]] = suppressMessages(mcmc_intervals(post,
               pars = paste0("PIg[",gl,",",seq(1,(NPtypes-1)),"]"),
               prob = 0.8) + 
      scale_y_discrete(name="Diet Type",labels=dfPtp$Description) +
      ggtitle(plot_title[g],subtitle = paste0("Group level ",Grouplist[gl,4])) 
    )
  }
  grid.arrange(grobs=plts,ncol=length(GL))

```

```{r Fig8, echo=FALSE, warning=FALSE, eval=Grp_TF, fig.cap = "Figure 8. Caterpiller plot showing posterior distributions for *er*~*g,j*~, the rate of energy intake while feeding on each prey type *j* for group *g* "}

  if(length(Grpvar)==1){
    Grpvartxt = Grpvar
  }else{
    Grpvartxt = paste(Grpvar, collapse = ', ')
  }
  
  GL = numeric()
  if(params$GL1>0){GL = c(GL,params$GL1) }
  if(params$GL2>0){GL = c(GL,params$GL2) }
  if(params$GL3>0){GL = c(GL,params$GL3) }

  plot_title = c(paste0("Rate of Energy Intake (kcal/min) by prey type, by ",Grpvartxt,
                      ", Forage data ",Projectname),"","")
  plts = list()
  for(g in 1:length(GL)){
    gl = GL[g]
    plts[[g]] = suppressMessages(mcmc_intervals(post,
               pars = paste0("ERg[",gl,",",seq(1,(NPtypes-1)),"]"),
               prob = 0.8) + 
      scale_y_discrete(name="Diet Type",labels=dfPtp$Description) +
      ggtitle(plot_title[g],subtitle = paste0("Group level ",Grouplist[gl,4])) 
    )
  }
  grid.arrange(grobs=plts,ncol=length(GL))

```

<div style="margin-bottom:50px;">
</div>

### Tables, statistics for ALL data 

```{r Table3, echo=FALSE}

ii = c(which(vns=="CRmn"), 
       which(vns=="ERmn"))

paramstats = data.frame(Parameter = c("CR_bar","ER_bar" ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
paramstats <- paramstats %>% mutate_if(is.numeric, signif, digits = 4)
kable(paramstats, row.names = FALSE, align = "l",
      caption = "Table 3. Parameter estimates for consumption rate (${{\\bar{CR}}}$, g/min) and rate of energy intake (${{\\bar{ER}}}$, kcal/min) for the overall data set")
 

```

```{r Table4, echo=FALSE}

ii = c(which(startsWith(vns,"SZ[")))

paramstats = data.frame(Parameter = c(paste0("S_bar_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 4. Parameter estimates for mean size, ${{\\bar{S}}_{j}}$ (mm), by prey type, for the overall data set")

```

```{r Table5, echo=FALSE}

ii = c(which(startsWith(vns,"HT[")))

paramstats = data.frame(Parameter = c(paste0("H_bar_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 5. Parameter estimates for mean handling time, ${{\\bar{H}}_{j}}$ (sec), by prey type, for the overall data set")

```

```{r Table6, echo=FALSE}

ii = c(which(startsWith(vns,"CR[")))

paramstats = data.frame(Parameter = c(paste0("cr_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 6. Parameter estimates for mean consumption rate by prey type ${{\\bar{cr}}_{j}}$ (g/min), for the overall data set")

```

```{r Table7, echo=FALSE}

ii = c(which(startsWith(vns,"ER[")))

paramstats = data.frame(Parameter = c(paste0("er_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 7. Parameter estimates for mean energy intake rate by prey type ${{\\bar{er}}_{j}}$ (kcal/min), for the overall data set")

```

```{r Table8, echo=FALSE}

ii = c(which(startsWith(vns,"phi1[")))

paramstats = data.frame(Parameter = c(paste0("phi_1_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 8. Estimates for $\\phi$~*1,j*~, intercept parameter for function relating log consumption rate to log size, by prey type, for the overall data set")

```

```{r Table9, echo=FALSE}

ii = c(which(startsWith(vns,"phi2[")))

paramstats = data.frame(Parameter = c(paste0("phi_2_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 9. Estimates for $\\phi$~*2,j*~, slope parameter for function relating log consumption rate to log size, by prey type, for the overall data set")

```

```{r Table10, echo=FALSE}

ii = c(which(startsWith(vns,"psi1[")))

paramstats = data.frame(Parameter = c(paste0("psi_1_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 10. Estimates for $\\psi$~*1,j*~, intercept parameter for function relating log handling time to log size, by prey type, for the overall data set")

```

```{r Table11, echo=FALSE}

ii = c(which(startsWith(vns,"psi2[")))

paramstats = data.frame(Parameter = c(paste0("psi_2_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 11. Estimates for $\\psi$~*2,j*~, slope parameter for function relating log handling time to log size, by prey type, for the overall data set")

```

```{r Table12, echo=FALSE}

ii = c(which(startsWith(vns,"eta[")))

paramstats = data.frame(Parameter = c(paste0("eta_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 12. Estimates for $\\eta$~*j*~, proportional allocation of effort to prey type j, for the overall data set")

```

```{r Table13, echo=FALSE}

ii = c(which(startsWith(vns,"PI[")))

paramstats = data.frame(Parameter = c(paste0("pi_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 13. Estimates for $\\pi$~*j*~, proportion of diet (consumed biomass) consisting of prey type j, for the overall data set")

```

```{r Table14, echo=FALSE}

ii = c(which(startsWith(vns,"Omega[")))

paramstats = data.frame(Parameter = c(paste0("omega_",seq(1,(NPtypes-1))) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 14. Estimates for $\\omega$~*j*~, probability that prey type *j* is positively identified (and thus not recorded as 'Un-ID' prey)")

```

```{r Table15, echo=FALSE}

ii = c(which(startsWith(vns,"sigSZ[")), 
       which(startsWith(vns,"sigHT[")),
       which(startsWith(vns,"sigCR[")),
       which(startsWith(vns,"tauB")),
       which(startsWith(vns,"tauG")))
if(Grp_TF){
  paramstats = data.frame(Parameter = c(paste0("sigma_s_",seq(1,(NPtypes-1))),
                                      paste0("sigma_h_",seq(1,(NPtypes-1))),
                                      paste0("sigma_c_",seq(1,(NPtypes-1))),
                                      paste0("tau_b_",seq(1,Ngrp)),
                                      "tau_g"))
}else{
  paramstats = data.frame(Parameter = c(paste0("sigma_s_",seq(1,(NPtypes-1))),
                                      paste0("sigma_h_",seq(1,(NPtypes-1))),
                                      paste0("sigma_c_",seq(1,(NPtypes-1))),
                                      "tau_b"))
}
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
paramstats <- paramstats %>% mutate_if(is.numeric, signif, digits = 4)
kable(paramstats, row.names = FALSE, align = "l",
      caption = "Table 15. Estimates for model variance and precision parameters. Prey-specific standard error values are shown for log-normally distributed observed variables of prey size ($\\sigma_{s,j}$), handling time ($\\sigma_{h,j}$) and consumption rate ($\\sigma_{c,j}$). Also shown are precision parameters for Dirichlet distributions that describe the relative frequencies of different prey types. Precision parameters determine the consistency in diet composition across bouts ($\\tau$~*b*~) and, if applicable, across different groups ($\\tau$~*g*~)") 

```

<div style="margin-bottom:50px;">
</div>

`r if(params$show.grptxt){"### Tables, statistics by group level "}`

```{r Table16, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"CRgmn[")), 
       which(startsWith(vns,"ERgmn[")))

paramstats = data.frame(Parameter = c(paste0("CR_",seq(1,Ngrp)),
                                      paste0("ER_",seq(1,Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
paramstats <- paramstats %>% mutate_if(is.numeric, signif, digits = 4)
kable(paramstats, row.names = FALSE, align = "l",
      caption = "Table 16. Parameter estimates for consumption rate (*CR*~*g*~, g/min) and rate of energy intake (*ER*~*g*~, kcal/min) for each group level *g*")

```

```{r Table17, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"SZg[")))

paramstats = data.frame(Parameter = c(paste0("S_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 17. Parameter estimates for mean size, *S*~*g,j*~, by group level *g* and by prey type *j*")

```

```{r Table18, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"HTg[")))

paramstats = data.frame(Parameter = c(paste0("H_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 18. Parameter estimates for mean handling time, *H*~*g,j*~, by group level *g* and by prey type *j*")

```

```{r Table19, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"CRg[")))

paramstats = data.frame(Parameter = c(paste0("cr_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 19. Parameter estimates for mean consumption rate *cr*~*g,j*~, by group level *g* and by prey type *j*")

```

```{r Table20, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"ERg[")))

paramstats = data.frame(Parameter = c(paste0("er_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 20. Parameter estimates for mean energy intake rate *er*~*g,j*~, (kcal/min), by group level *g* and by prey type *j*")

```

```{r Table21, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"phi1G[")))

paramstats = data.frame(Parameter = c(paste0("phi_1_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 21. Estimates for $\\phi$~*1,g,j*~, intercept parameter for function relating log consumption rate to log size, for each group *g* and prey type *j*")

```

```{r Table22, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"psi1G[")))

paramstats = data.frame(Parameter = c(paste0("psi_1_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 22. Estimates for $\\psi$~*1,g,j*~, intercept parameter for function relating log handling time to log size, for each group *g* and prey type *j*")

```

```{r Table23, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"etaG[")))

paramstats = data.frame(Parameter = c(paste0("eta_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 23. Estimates for $\\eta$~*g,j*~, proportional allocation of effort to prey type j, for each group level *g*")

```

```{r Table24, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"PIg[")))

paramstats = data.frame(Parameter = c(paste0("pi_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 24. Estimates for $\\pi$~*g,j*~, proportion of diet (consumed biomass) consisting of prey type j, for each group level *g*")

```

```{r Table25, eval=Grp_TF, echo=FALSE}

ii = c(which(startsWith(vns,"OmegaG[")))

paramstats = data.frame(Parameter = c(paste0("omega_", rep(seq(1,Ngrp),each=(NPtypes-1)), ",", rep(seq(1,(NPtypes-1)),Ngrp)) ))
paramstats = cbind(paramstats,sumstats[ii,c(1,3,4,8,9,10)])
kable(paramstats, row.names = FALSE,
      caption = "Table 25. Estimates for $\\omega$~*g,j*~, probability that prey type *j* is positively identified (and thus not recorded as 'Un-ID' prey) for each group level *g* ")

```


